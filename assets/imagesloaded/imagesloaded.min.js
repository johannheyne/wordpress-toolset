(function(e,t){"use strict";if(typeof define==="function"&&define.amd){define(["eventEmitter/EventEmitter","eventie/eventie"],function(n,r){return t(e,n,r)})}else if(typeof exports==="object"){module.exports=t(e,require("wolfy87-eventemitter"),require("eventie"))}else{e.imagesLoaded=t(e,e.EventEmitter,e.eventie)}})(window,function(t,n,r){"use strict";function u(e,t){for(var n in t){e[n]=t[n]}return e}function f(e){return a.call(e)==="[object Array]"}function l(e){var t=[];if(f(e)){t=e}else if(typeof e.length==="number"){for(var n=0,r=e.length;n<r;n++){t.push(e[n])}}else{t.push(e)}return t}function c(e,t,n){if(!(this instanceof c)){return new c(e,t)}if(typeof e==="string"){e=document.querySelectorAll(e)}this.elements=l(e);this.options=u({},this.options);if(typeof t==="function"){n=t}else{u(this.options,t)}if(n){this.on("always",n)}this.getImages();if(i){this.jqDeferred=new i.Deferred}var r=this;setTimeout(function(){r.check()})}function h(e){this.img=e}function d(e){this.src=e;p[e]=this}var i=t.jQuery;var s=t.console;var o=typeof s!=="undefined";var a=Object.prototype.toString;c.prototype=new n;c.prototype.options={};c.prototype.getImages=function(){this.images=[];for(var e=0,t=this.elements.length;e<t;e++){var n=this.elements[e];if(n.nodeName==="IMG"){this.addImage(n)}var r=n.nodeType;if(!r||!(r===1||r===9||r===11)){continue}var i=n.querySelectorAll("img");for(var s=0,o=i.length;s<o;s++){var u=i[s];this.addImage(u)}}};c.prototype.addImage=function(e){var t=new h(e);this.images.push(t)};c.prototype.check=function(){function r(r,i){if(e.options.debug&&o){s.log("confirm",r,i)}e.progress(r);t++;if(t===n){e.complete()}return true}var e=this;var t=0;var n=this.images.length;this.hasAnyBroken=false;if(!n){this.complete();return}for(var i=0;i<n;i++){var u=this.images[i];u.on("confirm",r);u.check()}};c.prototype.progress=function(e){this.hasAnyBroken=this.hasAnyBroken||!e.isLoaded;var t=this;setTimeout(function(){t.emit("progress",t,e);if(t.jqDeferred&&t.jqDeferred.notify){t.jqDeferred.notify(t,e)}})};c.prototype.complete=function(){var e=this.hasAnyBroken?"fail":"done";this.isComplete=true;var t=this;setTimeout(function(){t.emit(e,t);t.emit("always",t);if(t.jqDeferred){var n=t.hasAnyBroken?"reject":"resolve";t.jqDeferred[n](t)}})};if(i){i.fn.imagesLoaded=function(e,t){var n=new c(this,e,t);return n.jqDeferred.promise(i(this))}}h.prototype=new n;h.prototype.check=function(){var e=p[this.img.src]||new d(this.img.src);if(e.isConfirmed){this.confirm(e.isLoaded,"cached was confirmed");return}if(this.img.complete&&this.img.naturalWidth!==undefined){this.confirm(this.img.naturalWidth!==0,"naturalWidth");return}var t=this;e.on("confirm",function(e,n){t.confirm(e.isLoaded,n);return true});e.check()};h.prototype.confirm=function(e,t){this.isLoaded=e;this.emit("confirm",this,t)};var p={};d.prototype=new n;d.prototype.check=function(){if(this.isChecked){return}var e=new Image;r.bind(e,"load",this);r.bind(e,"error",this);e.src=this.src;this.isChecked=true};d.prototype.handleEvent=function(e){var t="on"+e.type;if(this[t]){this[t](e)}};d.prototype.onload=function(e){this.confirm(true,"onload");this.unbindProxyEvents(e)};d.prototype.onerror=function(e){this.confirm(false,"onerror");this.unbindProxyEvents(e)};d.prototype.confirm=function(e,t){this.isConfirmed=true;this.isLoaded=e;this.emit("confirm",this,t)};d.prototype.unbindProxyEvents=function(e){r.unbind(e.target,"load",this);r.unbind(e.target,"error",this)};return c})